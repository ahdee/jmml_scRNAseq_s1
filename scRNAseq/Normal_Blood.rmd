---
  title: "JMML: scRNAseq surface marker"
author: "by Alex"
output: 
  html_document:
  toc: TRUE
toc_float: FALSE
editor_options: 
  chunk_output_type: console
---
  
  
  <style type="text/css">
  .main-container {
    max-width: 1800px;
    margin-left: 20px;
    margin-right: auto;
  }
.toc-content {
  max-width: 1800px;
  margin-left: 50px;
  margin-right: auto;
}

div {
  
  margin-left: 20px;
}


hr.new1 {
  border-top: 1px solid #84a8e0;
}



</style>
  
  # Results {.tabset}
  
  
  <div style="background-color: #f0f5c1;">
  
  
  </div>
  
  <hr>
  
  
  
```{r setup, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, include = FALSE , cache.lazy = FALSE )

library ( dplyr)
library(scales)
library("RColorBrewer")
library("ggplot2")
library(gplots)
library(ggrepel)
library(Hmisc)
library(stringr)
library(gridExtra)
library(knitr)
library(kableExtra)
library ( openxlsx)
library ( ggbeeswarm )
library(Seurat)

options(scipen=999)
getPalette = colorRampPalette(brewer.pal(9, "Set1")) # expand color pallete

```


```{r}
# there are 5 samples 
raw_dir = "/projects/lab.mis/elliot/JMML_project1/raw/HTAN/scRNAseq/raw/"
samples = list.dirs(raw_dir)
samples = samples[ grepl ( "filtered", samples)]

normal_df = data.frame()
for ( s in samples ){
  id = str_match(s, ".*\\/(.*)\\/filtered")[, 2]
  normal_df = rbind ( normal_df , data.frame ( pid=id, dir=s))
}

```

```{r}
mt_cut = 15 
nfeature_min = 200 
nfeature_max = 2600


```

# pre-processing workflow

  * The steps below encompass the standard pre-processing workflow based on Seurat's Basic recommendations. However some paremeters might be tweaked for the specific experiments. 

  * Cells are filtered based on 2 main factors. 
    + cells that have unique feature counts over `nfeature_max` or less than `nfeature_min`
      ++ Low-quality cells or empty droplets will often have very few genes
      ++ Cell doublets or multiplets may exhibit an aberrantly high gene count
      ++ __Thus we try to find a Goldilock range: not too low but not too high__

    + cells with > `mt_cut`% ( here we set it to 12% ) mitochondrial counts. High mitochondrial indicates Low-quality / dying cells.
      ++ Low-quality / dying cells often exhibit extensive mitochondrial contamination
      ++ We calculate mitochondrial QC metrics with the `PercentageFeatureSet` function, which calculates the percentage of counts originating from a set of features
      ++ We use the set of all genes starting with `MT-` as a set of mitochondrial genes

```{r}
# preprocess each of the samples 

mt_cut = 15 
nfeature_min = 200 
nfeature_max = 2600


r=1 
pid = normal_df[r:r, ]

# Load the data
data <- Read10X(data.dir = pid$dir )
# Initialize the Seurat object with the raw (non-normalized data).
pbmc <- CreateSeuratObject(counts = data, project = "JMML_s1", min.cells = 3, min.features = 200)
# add mitochondria percent 
pbmc[["percent.mt"]] <- PercentageFeatureSet(pbmc, pattern = "^MT-")
head(pbmc@meta.data, 5)

# plot mitochondria 
mt_plot <- plot_hist_perc ( pbmc@meta.data, plot_this="percent.mt", ccc="#6e9be5" , cut_here = 15, msg = "" , binwidth=5, y=.3) 
nfeature_plot <- plot_hist_perc ( pbmc@meta.data, plot_this="nFeature_RNA", ccc="#6e9be5" 
                                  , cut_here = c (nfeature_min,  nfeature_max)
                                  , msg = "" 
                                  , binwidth=200, y=.02  # y is the position of annotated text
                                  ) 


# quantile ( pbmc@meta.data$percent.mt) # here we see that 50% of the cells will be removed if MT is set to 10% 
# quantile ( pbmc@meta.data$nFeature_RNA) # 25% will be removed if the high end is set to 2500 



# Visualize QC metrics as a violin plot
before_plot = VlnPlot(pbmc, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, cols="#FAF632" )
before_total = length ( Cells(pbmc) )

# after 
pbmc =  subset(pbmc, subset = nFeature_RNA > nfeature_min & nFeature_RNA < nfeature_max & percent.mt < mt_cut )
after_length ( Cells(pbmc) )
after_plot = VlnPlot(pbmc, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, cols="#526E9F")


(before + ggtitle(pid) ) / after 




```

